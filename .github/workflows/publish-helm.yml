name: Publish Helm Charts

on:
  push:
    branches:
      - main     

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Helm
        uses: azure/setup-helm@v3

      - name: Package Helm Charts
        run: |
          cp README.md chart/README.md
          mkdir -p packaged
          helm package ./chart -d packaged          

      - name: Clone gh-pages
        run: |
          git clone --branch gh-pages --depth 1 \
          https://github.com/PragmaticFlow/nbomber-timescale-helm gh-pages || mkdir gh-pages

      # Merge old index with new packages
      - name: Merge existing index.yaml
        run: |
          if [ -f gh-pages/index.yaml ]; then
            helm repo index packaged \
              --merge gh-pages/index.yaml \
              --url https://pragmaticflow.github.io/nbomber-timescale-helm/
          else
            echo "No existing index.yaml found â€” creating new one"
            helm repo index packaged \
              --url https://pragmaticflow.github.io/nbomber-timescale-helm/
          fi

      # Move new packaged files into gh-pages folder
      - name: Move packaged files
        run: |
          cp -r packaged/* gh-pages/

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./gh-pages
          publish_branch: gh-pages